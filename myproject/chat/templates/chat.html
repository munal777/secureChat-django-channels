<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>SecureChat - Private Rooms</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 50%,
          #2ecc71 100%
        );
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        position: relative;
        overflow: hidden;
      }

      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.05"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.05"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.03"/><circle cx="10" cy="50" r="0.5" fill="white" opacity="0.03"/><circle cx="90" cy="30" r="0.5" fill="white" opacity="0.03"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        pointer-events: none;
      }

      .chat-container {
        width: 100%;
        max-width: 850px;
        height: 88vh;
        max-height: 700px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        box-shadow: 0 32px 64px rgba(0, 0, 0, 0.12),
          0 0 0 1px rgba(255, 255, 255, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
      }

      .header-wrapper {
        position: relative;
        z-index: 100;
      }

      .back-to-dashboard {
        width: 44px;
        height: 44px;
        border: none;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        font-size: 16px;
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
        text-decoration: none;
      }

      .back-to-dashboard::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
      }

      .back-to-dashboard:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateX(-2px) scale(1.05);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        text-decoration: none;
      }

      .back-to-dashboard:hover::before {
        left: 100%;
      }

      .back-to-dashboard:active {
        transform: translateX(-1px) scale(0.98);
      }

      .back-to-dashboard .fa-arrow-left {
        font-size: 16px;
        transition: transform 0.2s ease;
      }

      .back-to-dashboard:hover .fa-arrow-left {
        transform: translateX(-2px);
      }

      .chat-header {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
        padding: 24px 28px;
        display: flex;
        align-items: center;
        gap: 16px;
        position: relative;
        z-index: 1;
      }

      .chat-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          transparent 30%,
          rgba(255, 255, 255, 0.1) 50%,
          transparent 70%
        );
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .avatar {
        width: 52px;
        height: 52px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        border: 2px solid rgba(255, 255, 255, 0.3);
        position: relative;
        z-index: 1;
      }

      .header-info {
        flex: 1;
        position: relative;
        z-index: 1;
      }

      .header-info h2 {
        font-weight: 700;
        font-size: 22px;
        margin-bottom: 4px;
        letter-spacing: -0.02em;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.1);
        }
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 32px 28px;
        background: linear-gradient(180deg, #fafbfc 0%, #f8fffe 100%);
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: relative;
      }

      .chat-messages::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: linear-gradient(
          180deg,
          rgba(250, 251, 252, 1) 0%,
          rgba(250, 251, 252, 0) 100%
        );
        pointer-events: none;
        z-index: 1;
      }

      .chat-messages::-webkit-scrollbar {
        width: 4px;
      }

      .chat-messages::-webkit-scrollbar-track {
        background: transparent;
      }

      .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(46, 204, 113, 0.3);
        border-radius: 2px;
      }

      .chat-messages::-webkit-scrollbar-thumb:hover {
        background: rgba(46, 204, 113, 0.5);
      }

      .message {
        display: flex;
        align-items: flex-end;
        gap: 12px;
        animation: messageSlide 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        max-width: 85%;
      }

      .message.own {
        flex-direction: row-reverse;
        margin-left: auto;
      }

      @keyframes messageSlide {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .date-separator {
        display: flex;
        align-items: center;
        margin: 32px 0 24px 0;
        opacity: 0.6;
      }

      .date-separator-line {
        flex: 1;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(46, 204, 113, 0.3),
          transparent
        );
      }

      .date-separator-text {
        padding: 0 16px;
        font-size: 12px;
        font-weight: 600;
        color: #7f8c8d;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        padding: 4px 12px;
        border: 1px solid rgba(46, 204, 113, 0.2);
      }

      .history-message {
        opacity: 0;
        animation: historyFadeIn 0.3s ease-out forwards;
      }

      .history-message:nth-child(n) {
        animation-delay: calc(var(--index, 0) * 0.05s);
      }

      @keyframes historyFadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 700;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.9);
      }

      .message.own .message-avatar {
        background: linear-gradient(135deg, #3498db, #2980b9);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
      }

      .message-content {
        background: white;
        padding: 16px 20px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08),
          0 1px 2px rgba(0, 0, 0, 0.05);
        position: relative;
        border: 1px solid rgba(46, 204, 113, 0.1);
        transition: all 0.2s ease;
      }

      .message-content:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12),
          0 2px 4px rgba(0, 0, 0, 0.08);
      }

      .message.own .message-content {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .message-content::before {
        content: "";
        position: absolute;
        width: 12px;
        height: 12px;
        background: white;
        transform: rotate(45deg);
        bottom: 6px;
      }

      .message:not(.own) .message-content::before {
        left: -5px;
        border-left: 1px solid rgba(46, 204, 113, 0.1);
        border-bottom: 1px solid rgba(46, 204, 113, 0.1);
      }

      .message.own .message-content::before {
        right: -5px;
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        border-right: 1px solid rgba(255, 255, 255, 0.2);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .message-sender {
        font-size: 12px;
        font-weight: 700;
        color: #2ecc71;
        margin-bottom: 6px;
        letter-spacing: 0.02em;
      }

      .message.own .message-sender {
        color: rgba(255, 255, 255, 0.9);
      }

      .message-text {
        font-size: 15px;
        line-height: 1.5;
        word-wrap: break-word;
        color: #2c3e50;
      }

      .message.own .message-text {
        color: white;
      }

      .message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 6px;
        font-weight: 500;
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        padding: 40px;
      }

      .empty-state-icon {
        font-size: 64px;
        margin-bottom: 24px;
        opacity: 0.4;
        animation: float 3s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .empty-state-text {
        font-size: 18px;
        color: #7f8c8d;
        font-weight: 500;
        margin-bottom: 8px;
      }

      .empty-state-subtext {
        font-size: 14px;
        color: #bdc3c7;
      }

      .chat-input-container {
        padding: 28px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(46, 204, 113, 0.1);
      }

      .chat-input {
        display: flex;
        align-items: center;
        gap: 16px;
        background: white;
        border: 2px solid rgba(46, 204, 113, 0.2);
        border-radius: 28px;
        padding: 6px 8px 6px 24px;
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        box-shadow: 0 8px 32px rgba(46, 204, 113, 0.08),
          0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .chat-input:focus-within {
        border-color: #2ecc71;
        box-shadow: 0 12px 40px rgba(46, 204, 113, 0.15),
          0 0 0 4px rgba(46, 204, 113, 0.08);
        transform: translateY(-2px);
      }

      .message-input {
        flex: 1;
        border: none;
        outline: none;
        background: transparent;
        font-size: 16px;
        padding: 16px 0;
        color: #2c3e50;
        font-weight: 500;
      }

      .message-input::placeholder {
        color: #bdc3c7;
        font-weight: 400;
      }

      .send-button {
        width: 48px;
        height: 48px;
        border: none;
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        font-size: 18px;
        font-weight: bold;
        box-shadow: 0 4px 16px rgba(46, 204, 113, 0.3);
        position: relative;
        overflow: hidden;
      }

      .send-button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.5s;
      }

      .send-button:hover {
        transform: scale(1.05) rotate(5deg);
        box-shadow: 0 8px 24px rgba(46, 204, 113, 0.4);
      }

      .send-button:hover::before {
        left: 100%;
      }

      .send-button:active {
        transform: scale(0.95);
      }

      .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      @media (max-width: 768px) {
        body {
          padding: 8px;
        }

        .chat-container {
          height: 92vh;
          border-radius: 20px;
          max-height: none;
        }

        .back-to-dashboard {
          width: 40px;
          height: 40px;
          border-radius: 14px;
        }

        .back-to-dashboard .fa-arrow-left {
          font-size: 14px;
        }

        .chat-header {
          padding: 20px 24px;
          gap: 12px;
        }

        .chat-messages {
          padding: 24px 20px;
          gap: 16px;
        }

        .chat-input-container {
          padding: 20px;
        }

        .message {
          max-width: 90%;
        }

        .message-content {
          padding: 14px 18px;
        }
      }

      @media (max-width: 480px) {
        .back-to-dashboard {
          width: 36px;
          height: 36px;
          border-radius: 12px;
        }

        .back-to-dashboard .fa-arrow-left {
          font-size: 12px;
        }
        .chat-header {
          padding: 16px 20px;
          gap: 10px;
        }

        .back-to-dashboard.loading {
          pointer-events: none;
          opacity: 0.7;
        }

        .back-to-dashboard.loading .fa-arrow-left {
          display: none;
        }

        .back-to-dashboard.loading::after {
          content: "";
          width: 16px;
          height: 16px;
          border: 2px solid rgba(255, 255, 255, 0.3);
          border-top: 2px solid rgba(255, 255, 255, 0.9);
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }

        /* Tooltip for back button */
        .back-to-dashboard[title]:hover::before {
          content: attr(title);
          position: absolute;
          bottom: -35px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 12px;
          white-space: nowrap;
          z-index: 1000;
          animation: tooltipFadeIn 0.2s ease;
        }

        @keyframes tooltipFadeIn {
          from {
            opacity: 0;
            transform: translateX(-50%) translateY(-5px);
          }
          to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
          }
        }

        .avatar {
          width: 44px;
          height: 44px;
          font-size: 18px;
        }

        .header-info h2 {
          font-size: 20px;
        }

        .chat-messages {
          padding: 20px 16px;
        }

        .chat-input-container {
          padding: 16px;
        }

        .message-content {
          padding: 12px 16px;
        }

        .message-text {
          font-size: 14px;
        }
      }

      /* File content styling - Add these styles to your existing CSS */

      /* File preview container */
      .file-preview {
        margin: 8px 0;
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.02);
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .message.own .file-preview {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      /* Image preview styling */
      .file-preview img {
        width: 100%;
        height: auto;
        max-width: 280px;
        max-height: 200px;
        object-fit: cover;
        display: block;
        border-radius: 12px;
        transition: transform 0.2s ease;
        cursor: pointer;
      }

      .file-preview img:hover {
        transform: scale(1.02);
      }

      /* Video preview styling */
      .file-preview video {
        width: 100%;
        height: auto;
        max-width: 280px;
        max-height: 200px;
        border-radius: 12px;
        background: #000;
      }

      /* File attachment styling */
      .file-attachment {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(248, 249, 250, 0.8);
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.06);
        margin: 8px 0;
        transition: all 0.2s ease;
        min-width: 200px;
        max-width: 300px;
      }

      .message.own .file-attachment {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .file-attachment:hover {
        background: rgba(248, 249, 250, 1);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .message.own .file-attachment:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* File icon styling */
      .file-icon {
        font-size: 24px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(46, 204, 113, 0.1);
        border-radius: 8px;
        flex-shrink: 0;
      }

      .message.own .file-icon {
        background: rgba(255, 255, 255, 0.2);
      }

      /* File info styling */
      .file-info {
        flex: 1;
        min-width: 0;
      }

      .file-name {
        font-size: 14px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .message.own .file-name {
        color: rgba(255, 255, 255, 0.95);
      }

      .file-size {
        font-size: 12px;
        color: #7f8c8d;
        font-weight: 500;
      }

      .message.own .file-size {
        color: rgba(255, 255, 255, 0.7);
      }

      /* File download button styling */
      .file-download {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(46, 204, 113, 0.1);
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.2s ease;
        flex-shrink: 0;
        color: #2ecc71;
      }

      .message.own .file-download {
        background: rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.9);
      }

      .file-download:hover {
        background: rgba(46, 204, 113, 0.2);
        transform: scale(1.1);
      }

      .message.own .file-download:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* File button styling (attach button) */
      .file-button {
        width: 40px;
        height: 40px;
        border: none;
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 16px;
        flex-shrink: 0;
      }

      .file-button:hover {
        background: rgba(46, 204, 113, 0.2);
        transform: scale(1.05);
      }

      .file-button:active {
        transform: scale(0.95);
      }

      /* Image modal for full-size viewing */
      .image-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
      }

      .image-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .image-modal img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }

      .image-modal-close {
        position: absolute;
        top: 20px;
        right: 30px;
        font-size: 30px;
        color: white;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.5);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .image-modal-close:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: scale(1.1);
      }

      /* Mobile responsive adjustments */
      @media (max-width: 768px) {
        .file-preview img,
        .file-preview video {
          max-width: 220px;
          max-height: 160px;
        }
        
        .file-attachment {
          max-width: 250px;
          min-width: 180px;
        }
        
        .file-name {
          font-size: 13px;
        }
        
        .file-size {
          font-size: 11px;
        }
      }

      @media (max-width: 480px) {
        .file-preview img,
        .file-preview video {
          max-width: 200px;
          max-height: 140px;
        }
        
        .file-attachment {
          max-width: 220px;
          min-width: 160px;
          padding: 10px;
        }
        
        .file-icon {
          font-size: 20px;
          width: 36px;
          height: 36px;
        }
        
        .file-download {
          width: 28px;
          height: 28px;
          font-size: 12px;
        }
      }

      /* Voice Message Styling - Add these styles to your existing CSS */

      /* Voice button styling */
      .voice-button {
        width: 40px;
        height: 40px;
        border: none;
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 16px;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
      }

      .voice-button:hover {
        background: rgba(46, 204, 113, 0.2);
        transform: scale(1.05);
      }

      .voice-button:active {
        transform: scale(0.95);
      }

      /* Recording state styling */
      .voice-button.recording {
        background: rgba(255, 68, 68, 0.2);
        color: #ff4444;
        animation: pulseRecord 1s ease-in-out infinite;
      }

      @keyframes pulseRecord {
        0%, 100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.4);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 0 8px rgba(255, 68, 68, 0.1);
        }
      }

    /* Voice message container */
    .voice-message {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 8px 0;
      padding: 12px;
      background: rgba(248, 249, 250, 0.8);
      border-radius: 12px;
      border: 1px solid rgba(46, 204, 113, 0.1);
      transition: all 0.2s ease;
      min-width: 200px;
      max-width: 300px;
    }

    .message.own .voice-message {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .voice-message:hover {
      background: rgba(248, 249, 250, 1);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .message.own .voice-message:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Voice controls container */
    .voice-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Voice play button */
    .voice-play-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 16px;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
    }

    .message.own .voice-play-btn {
      background: linear-gradient(135deg, #3498db, #2980b9);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }

    .voice-play-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(46, 204, 113, 0.4);
    }

    .message.own .voice-play-btn:hover {
      box-shadow: 0 6px 16px rgba(52, 152, 219, 0.4);
    }

    .voice-play-btn:active {
      transform: scale(0.95);
    }

    /* Voice info container */
    .voice-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .voice-label {
      font-size: 13px;
      font-weight: 600;
      color: #2ecc71;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .message.own .voice-label {
      color: rgba(255, 255, 255, 0.9);
    }

    .voice-duration {
      font-size: 11px;
      color: #7f8c8d;
      font-weight: 500;
      font-family: 'Courier New', monospace;
    }

    .message.own .voice-duration {
      color: rgba(255, 255, 255, 0.7);
    }

    /* Voice waveform animation (optional visual enhancement) */
    .voice-waveform {
      display: flex;
      align-items: center;
      gap: 2px;
      margin-top: 4px;
    }

    .voice-waveform .bar {
      width: 3px;
      height: 12px;
      background: rgba(46, 204, 113, 0.3);
      border-radius: 1px;
      animation: waveform 1.5s ease-in-out infinite;
    }

    .message.own .voice-waveform .bar {
      background: rgba(255, 255, 255, 0.4);
    }

    .voice-waveform .bar:nth-child(1) { animation-delay: 0s; }
    .voice-waveform .bar:nth-child(2) { animation-delay: 0.1s; }
    .voice-waveform .bar:nth-child(3) { animation-delay: 0.2s; }
    .voice-waveform .bar:nth-child(4) { animation-delay: 0.3s; }
    .voice-waveform .bar:nth-child(5) { animation-delay: 0.4s; }

    @keyframes waveform {
      0%, 100% {
        height: 12px;
        opacity: 0.3;
      }
      50% {
        height: 20px;
        opacity: 1;
      }
    }

    /* Audio element styling */
    .voice-message audio {
      display: none; /* Hide the default audio controls */
    }

    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .voice-message {
        max-width: 250px;
        min-width: 180px;
      }
      
      .voice-play-btn {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }
      
      .voice-label {
        font-size: 12px;
      }
      
      .voice-duration {
        font-size: 10px;
      }
    }

    @media (max-width: 480px) {
      .voice-message {
        max-width: 220px;
        min-width: 160px;
        padding: 10px;
      }
      
      .voice-play-btn {
        width: 32px;
        height: 32px;
        font-size: 12px;
      }
      
      .voice-button {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }
    }

    /* Group info container */
    .group-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 4px;
    }

    .group-indicator {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 8px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Members toggle button */
    .members-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 11px;
      font-weight: 500;
    }

    .members-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    .members-count {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .chevron {
      font-size: 10px;
      transition: transform 0.2s ease;
    }

    .members-toggle.active .chevron {
      transform: rotate(180deg);
    }

    /* Header actions */
    .header-actions {
      display: flex;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .leave-group-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 68, 68, 0.9);
      border: 1px solid rgba(255, 68, 68, 0.35);
      color: rgba(255, 255, 255, 0.9);
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
      font-weight: 500;
    }

    .leave-group-btn:hover {
      background: rgb(255, 68, 68);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgb(255, 68, 68);
    }

    .leave-icon {
      font-size: 14px;
    }

    .leave-text {
      font-weight: 600;
    }

    /* Members list overlay */
    .members-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(46, 204, 113, 0.2);
      border-radius: 0 0 16px 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      z-index: 9999;
      max-height: 300px;
      overflow-y: auto;
      min-height: 50px;
      visibility: hidden; /* Use CSS display instead of inline style */
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      pointer-events: none; 
    }

    /* Show state for members list */
    .members-list.show {
      visibility: visible;
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .members-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(46, 204, 113, 0.1);
      background: rgba(46, 204, 113, 0.05);
    }

    .members-header h3 {
      margin: 0;
      color: #2ecc71;
      font-size: 16px;
      font-weight: 600;
    }

    .close-members {
      width: 28px;
      height: 28px;
      border: none;
      background: rgba(255, 68, 68, 0.1);
      color: #ff4444;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.2s ease;
    }

    .close-members:hover {
      background: rgba(255, 68, 68, 0.2);
      transform: scale(1.1);
    }

    .members-content {
      padding: 12px 0;
    }

    .member-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 20px;
      transition: background 0.2s ease;
    }

    .member-item:hover {
      background: rgba(46, 204, 113, 0.05);
    }

    .member-avatar {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .member-name {
      font-size: 14px;
      color: #2c3e50;
      font-weight: 500;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .group-info {
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .members-toggle,
      .leave-group-btn {
        font-size: 10px;
        padding: 3px 8px;
      }
      
      .leave-text {
        display: none;
      }
      
      .members-list {
        max-height: 250px;
      }
    }

    @media (max-width: 480px) {
      .header-info h2 {
        font-size: 18px;
      }
      
      .group-indicator {
        font-size: 10px;
        padding: 1px 6px;
      }
      
      .members-toggle {
        padding: 2px 6px;
      }
      
      .leave-group-btn {
        padding: 4px 8px;
      }
      
      .member-item {
        padding: 6px 16px;
      }
      
      .member-avatar {
        width: 28px;
        height: 28px;
        font-size: 11px;
      }
    }

    /* Font Awesome icon styling adjustments */
    .fa-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* Leave group button icon */
    .leave-group-btn .fa-door-open {
      font-size: 14px;
      margin-right: 2px;
    }

    /* Voice button icons */
    .voice-button .fa-microphone,
    .voice-button .fa-stop {
      font-size: 16px;
    }

    /* File button icon */
    .file-button .fa-paperclip {
      font-size: 16px;
    }

    /* Send button icon */
    .send-button .fa-paper-plane {
      font-size: 16px;
    }

    /* Voice message play/pause buttons */
    .voice-play-btn .fa-play,
    .voice-play-btn .fa-pause {
      font-size: 14px;
    }

    /* Members toggle icons */
    .members-count .fa-users {
      font-size: 10px;
      margin-right: 2px;
    }

    .chevron .fa-chevron-down {
      font-size: 8px;
      transition: transform 0.2s ease;
    }

    .members-toggle.active .chevron .fa-chevron-down {
      transform: rotate(180deg);
    }

    /* Close members button */
    .close-members .fa-times {
      font-size: 14px;
    }

    /* Room avatar icons */
    .avatar .fa-users,
    .avatar .fa-comments {
      font-size: 18px;
    }

    /* File type icons in messages */
    .file-icon .fa-image,
    .file-icon .fa-video,
    .file-icon .fa-music,
    .file-icon .fa-file-pdf,
    .file-icon .fa-file-word,
    .file-icon .fa-file-excel,
    .file-icon .fa-file-powerpoint,
    .file-icon .fa-file-archive,
    .file-icon .fa-file-alt,
    .file-icon .fa-cog,
    .file-icon .fa-folder {
      font-size: 20px;
    }

    /* File download icon */
    .file-download .fa-download {
      font-size: 12px;
    }

    /* Voice message label icon */
    .voice-label .fa-microphone {
      font-size: 11px;
      margin-right: 2px;
    }
    </style>
  </head>
  <body>
  <div class="chat-container">
    <div class="header-wrapper">
      <div class="chat-header">
        <a href={% url 'dashboard' %} class="back-to-dashboard" title="Back to Dashboard">
          <i class="fas fa-arrow-left"></i>
        </a>
        <div class="avatar">
          <span id="room-avatar">
            {% if is_group %}
              <i class="fas fa-users"></i>
            {% else %}
              <i class="fas fa-comments"></i>
            {% endif %}
          </span>
        </div>
        <div class="header-info">
          <h2 id="room-name">{% if is_group %}{{ room_name }}{% else %}{{ room_member }}{% endif %}</h2>
          {% if is_group %}
          <div class="group-info">
            <span class="group-indicator">Group Chat</span>
            <button class="members-toggle" id="membersToggle">
              <span class="members-count">
                <i class="fas fa-users"></i> {{ members_num }} members
              </span>
              <span class="chevron">
                <i class="fas fa-chevron-down"></i>
              </span>
            </button>
          </div>
          {% endif %}
        </div>
        {% if is_group %}
        <div class="header-actions">
          <button class="leave-group-btn" id="leaveGroupBtn">
            <i class="fas fa-door-open leave-icon"></i>
            <span class="leave-text">Leave</span>
          </button>
        </div>
        {% endif %}
      </div>
      
      {% if is_group %}
      <div class="members-list" id="membersList">
        <div class="members-header">
          <h3>Group Members</h3>
          <button class="close-members" id="closeMembersBtn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="members-content">
          {% for member in members_list %}
          <div class="member-item">
            <div class="member-avatar">{{ member|first|upper }}</div>
            <span class="member-name">{{ member }}</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <div class="chat-messages" id="chat-messages">
      <div class="empty-state">
        <div class="empty-state-icon"><i class="fas fa-comments" style="font-size: 48px;"></i></div>
        <div class="empty-state-text">Start your conversation</div>
        <div class="empty-state-subtext">Send a message to begin chatting</div>
      </div>
    </div>

    <div class="chat-input-container">
      <div class="chat-input">
        <input
          type="text"
          id="message-input"
          class="message-input"
          placeholder="Type your message..."
          autocomplete="off"
        />
        <input
          type="file"
          id="file-input"
          accept="image/*,video/*,.pdf,.doc,.docx,.txt,.zip,.rar"
          style="display: none;"
        />
        <button id="file-button" class="file-button">
          <i class="fas fa-paperclip"></i>
        </button>
        <button id="voice-button" class="voice-button">
          <i class="fas fa-microphone"></i>
        </button>
        <button id="send-button" class="send-button">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

    <script>
         const roomName = "{{ room_name }}";
         const currentUser = "{{ request.user.username }}"; // Get current user from Django
         const chatSocket = new WebSocket(
              `ws://${window.location.host}/ws/chat/{% if is_group %}group{% else %}private{% endif %}/${roomName}/`
         );

         const chatMessages = document.getElementById('chat-messages');
         const messageInput = document.getElementById('message-input');
         const sendButton = document.getElementById('send-button');
         const fileInput = document.getElementById('file-input');
         const fileButton = document.getElementById('file-button');
         const voiceButton = document.getElementById('voice-button');

         // Voice recording variables
         let mediaRecorder;
         let audioChunks = [];
         let isRecording = false;

        // Chat history from Django context
        const chatHistory = [
        {% for message in messages %}
            {
                sender: "{{ message.sender.username|escapejs }}",
                message: "{{ message.content|escapejs }}",
                timestamp: "{{ message.timestamp|date:'c' }}"
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
        ];


         // Remove empty state when first message arrives
         function removeEmptyState() {
             const emptyState = chatMessages.querySelector('.empty-state');
             if (emptyState) {
                 emptyState.style.animation = 'messageSlide 0.3s reverse';
                 setTimeout(() => emptyState.remove(), 300);
             }
         }

         // Format time from timestamp
         function formatTime(timestamp = null) {
             const date = timestamp ? new Date(timestamp) : new Date();
             return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
         }

         // Format date for message grouping
         function formatDate(timestamp) {
             const date = new Date(timestamp);
             const today = new Date();
             const yesterday = new Date(today);
             yesterday.setDate(yesterday.getDate() - 1);

             if (date.toDateString() === today.toDateString()) {
                 return 'Today';
             } else if (date.toDateString() === yesterday.toDateString()) {
                 return 'Yesterday';
             } else {
                 return date.toLocaleDateString([], {
                     month: 'short',
                     day: 'numeric',
                     year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
                 });
             }
         }

         // Create date separator
         function createDateSeparator(dateStr) {
             const separator = document.createElement('div');
             separator.className = 'date-separator';
             separator.innerHTML = `
                 <div class="date-separator-line"></div>
                 <div class="date-separator-text">${dateStr}</div>
                 <div class="date-separator-line"></div>
             `;
             return separator;
         }

          // Format file size
         function formatFileSize(bytes) {
             if (bytes === 0) return '0 Bytes';
             const k = 1024;
             const sizes = ['Bytes', 'KB', 'MB', 'GB'];
             const i = Math.floor(Math.log(bytes) / Math.log(k));
             return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
         }

        function getFileIcon(mimetype) {
            if (mimetype.startsWith("image/")) return '<i class="fas fa-image"></i>'
            if (mimetype.startsWith("video/")) return '<i class="fas fa-video"></i>'
            if (mimetype.startsWith("audio/")) return '<i class="fas fa-music"></i>'
            if (mimetype.includes("pdf")) return '<i class="fas fa-file-pdf"></i>'
            if (mimetype.includes("word") || mimetype.includes("document")) return '<i class="fas fa-file-word"></i>'
            if (mimetype.includes("excel") || mimetype.includes("spreadsheet")) return '<i class="fas fa-file-excel"></i>'
            if (mimetype.includes("powerpoint") || mimetype.includes("presentation"))
              return '<i class="fas fa-file-powerpoint"></i>'
            if (mimetype.includes("zip") || mimetype.includes("rar") || mimetype.includes("7z"))
              return '<i class="fas fa-file-archive"></i>'
            if (mimetype.includes("text/")) return '<i class="fas fa-file-alt"></i>'
            if (mimetype.includes("json") || mimetype.includes("xml")) return '<i class="fas fa-cog"></i>'
            return '<i class="fas fa-folder"></i>'
        }

         // Function to open image in modal
        function openImageModal(imageSrc, filename) {
            let modal = document.getElementById('imageModal');
            if (!modal) {
                // Create modal if it doesn't exist
                modal = document.createElement('div');
                modal.id = 'imageModal';
                modal.className = 'image-modal';
                modal.innerHTML = `
                    <span class="image-modal-close" onclick="closeImageModal()">×</span>
                    <img id="modalImage" src="" alt="">
                `;
                document.body.appendChild(modal);
                
                // Close modal when clicking outside the image
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeImageModal();
                    }
                });
            }
            
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modalImage.alt = filename;
            modal.classList.add('active');
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        // Function to close image modal
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }

        // Add keyboard support for closing modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });

        // Create file message element
        function createFileMessage(sender, filename, mimetype, data, timestamp = null, isOwnMessage = null) {
             removeEmptyState();

             // Auto-detect if it's own message if not specified
             if (isOwnMessage === null) {
                 isOwnMessage = sender === currentUser;
             }

             const messageEl = document.createElement('div');
             messageEl.className = `message ${isOwnMessage ? 'own' : ''}`;

             const avatarLetter = sender.charAt(0).toUpperCase();
             const time = formatTime(timestamp);
             const displaySender = isOwnMessage ? 'You' : sender;
             const fileIcon = getFileIcon(mimetype);
             const fileSize = formatFileSize(atob(data).length);

             let fileContent = '';
             
             if (mimetype.startsWith('image/')) {
                 fileContent = `
                      <div class="file-preview">
                         <img src="data:${mimetype};base64,${data}"
                              alt="${filename}"
                              onclick="openImageModal(this.src, '${filename}')"
                              title="Click to view full size">
                      </div>
                      <div class="file-info" style="padding: 4px 0;">
                        <div class="file-name">${filename}</div>
                        <div class="file-size">${fileSize}</div>
                      </div>
                 `;
             } else if (mimetype.startsWith('video/')) {
                 fileContent = `
                      <div class="file-preview">
                         <video controls preload="metadata">
                             <source src="data:${mimetype};base64,${data}" type="${mimetype}">
                             Your browser does not support the video tag.
                         </video>
                      </div>
                      <div class="file-info" style="padding: 4px 0;">
                          <div class="file-name">${filename}</div>
                          <div class="file-size">${fileSize}</div>
                      </div>
                 `;
             } else {
                 fileContent = `
                     <div class="file-attachment">
                          <div class="file-icon">${fileIcon}</div>
                          <div class="file-info">
                             <div class="file-name" title="${filename}">${filename}</div>
                             <div class="file-size">${fileSize}</div>
                          </div>
                          <a href="data:${mimetype};base64,${data}" 
                            download="${filename}" 
                            class="file-download"
                            title="Download file"> <i class="fas fa-download"></i>
                          </a>
                     </div>
                 `;
             }

             messageEl.innerHTML = `
                 <div class="message-avatar">${avatarLetter}</div>
                 <div class="message-content">
                     <div class="message-sender">${displaySender}</div>
                     ${fileContent}
                     <div class="message-time">${time}</div>
                 </div>
             `;

             return messageEl;
         }


         // Create voice message element
        function createVoiceMessage(sender, filename, mimetype, data, timestamp = null, isOwnMessage = null) {
            removeEmptyState();

            // Auto-detect if it's own message if not specified
            if (isOwnMessage === null) {
                isOwnMessage = sender === currentUser;
            }

            const messageEl = document.createElement('div');
            messageEl.className = `message ${isOwnMessage ? 'own' : ''}`;

            const avatarLetter = sender.charAt(0).toUpperCase();
            const time = formatTime(timestamp);
            const displaySender = isOwnMessage ? 'You' : sender;
            const fileSize = formatFileSize(atob(data).length);

            const voiceContent = `
                <div class="voice-message">
                    <div class="voice-controls">
                        <button class="voice-play-btn" onclick="toggleVoicePlayback(this)">▶️</button>
                        <div class="voice-info">
                            <div class="voice-label">
                              <i class="fas fa-microphone"></i> Voice Message
                            </div>
                            <div class="voice-duration" id="duration-${Date.now()}">--:--</div>
                        </div>
                    </div>
                    <audio preload="metadata" onloadedmetadata="updateVoiceDuration(this)">
                        <source src="data:${mimetype};base64,${data}" type="${mimetype}">
                        Your browser does not support the audio element.
                    </audio>
                    <div class="file-size">${fileSize}</div>
                </div>
            `;

            messageEl.innerHTML = `
                <div class="message-avatar">${avatarLetter}</div>
                <div class="message-content">
                    <div class="message-sender">${displaySender}</div>
                    ${voiceContent}
                    <div class="message-time">${time}</div>
                </div>
            `;

            return messageEl;
        }

        // Toggle voice playback
        function toggleVoicePlayback(button) {
            const voiceMessage = button.closest('.voice-message');
            const audio = voiceMessage.querySelector('audio');
            
            if (audio.paused) {
                // Stop all other audio elements
                document.querySelectorAll('.voice-message audio').forEach(otherAudio => {
                    if (otherAudio !== audio) {
                        otherAudio.pause();
                        otherAudio.currentTime = 0;
                        // Reset other play buttons
                        otherAudio.closest('.voice-message').querySelector('.voice-play-btn').innerHTML = '<i class="fas fa-play"></i>';
                    }
                });
                
                audio.play()
                button.innerHTML = '<i class="fas fa-pause"></i>'

                audio.onended = () => {
                  button.innerHTML = '<i class="fas fa-play"></i>'
                  audio.currentTime = 0
                }
              } else {
                audio.pause()
                button.innerHTML = '<i class="fas fa-play"></i>'
                audio.currentTime = 0
              }
            }

        // Update voice duration display
        function updateVoiceDuration(audio) {
            const duration = audio.duration;
            const minutes = Math.floor(duration / 60);
            const seconds = Math.floor(duration % 60);
            const durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const voiceMessage = audio.closest('.voice-message');
            const durationElement = voiceMessage.querySelector('.voice-duration');
            if (durationElement) {
                durationElement.textContent = durationText;
            }
        }

         // Create text message element
         function createMessage(sender, message, timestamp = null, isOwnMessage = null) {
             removeEmptyState();

             // Auto-detect if it's own message if not specified
             if (isOwnMessage === null) {
                 isOwnMessage = sender === currentUser;
             }

             const messageEl = document.createElement('div');
             messageEl.className = `message ${isOwnMessage ? 'own' : ''}`;

             const avatarLetter = sender.charAt(0).toUpperCase();
             const time = formatTime(timestamp);
             const displaySender = isOwnMessage ? 'You' : sender;

             messageEl.innerHTML = `
                 <div class="message-avatar">${avatarLetter}</div>
                 <div class="message-content">
                     <div class="message-sender">${displaySender}</div>
                     <div class="message-text">${message}</div>
                     <div class="message-time">${time}</div>
                 </div>
             `;

             return messageEl;
         }

         // Load chat history
         function loadChatHistory() {
             if (chatHistory.length === 0) return;

             removeEmptyState();

             let lastDate = null;

             chatHistory.forEach(historyMessage => {
                 const messageDate = formatDate(historyMessage.timestamp);

                 // Add date separator if date changed
                 if (messageDate !== lastDate) {
                     const dateSeparator = createDateSeparator(messageDate);
                     chatMessages.appendChild(dateSeparator);
                     lastDate = messageDate;
                 }

                 const messageEl = createMessage(
                     historyMessage.sender,
                     historyMessage.message,
                     historyMessage.timestamp
                 );

                 // Add history class for styling with staggered animation
                 messageEl.classList.add('history-message');
                 messageEl.style.setProperty('--index', chatHistory.indexOf(historyMessage));
                 chatMessages.appendChild(messageEl);
             });

             // Scroll to bottom after loading history
             setTimeout(() => {
                 chatMessages.scrollTop = chatMessages.scrollHeight;
             }, 100);
         }

         // Smooth scroll to bottom
         function scrollToBottom() {
             chatMessages.scrollTo({
                 top: chatMessages.scrollHeight,
                 behavior: 'smooth'
             });
         }

         let lastSentMessage = null; // Track last sent message to prevent duplicates

          // Voice recording functions
         async function startVoiceRecording() {
             try {
                 const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                 mediaRecorder = new MediaRecorder(stream);
                 audioChunks = [];

                 mediaRecorder.ondataavailable = event => {
                     audioChunks.push(event.data);
                 };

                 mediaRecorder.onstop = async () => {
                     const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                     const reader = new FileReader();
                     
                     reader.onload = function(e) {
                         const base64Data = e.target.result.split(',')[1];
                         const filename = `voice_${Date.now()}.wav`;
                         
                         // Add voice message to UI immediately
                         const messageEl = createVoiceMessage(currentUser, filename, 'audio/wav', base64Data);
                         chatMessages.appendChild(messageEl);
                         scrollToBottom();

                         // Send voice message to WebSocket
                         chatSocket.send(JSON.stringify({
                             'type': 'voice',
                             'filename': filename,
                             'mimetype': 'audio/wav',
                             'data': base64Data
                         }));
                     };
                     
                     reader.readAsDataURL(audioBlob);
                     
                     // Stop all tracks
                     stream.getTracks().forEach(track => track.stop());
                 };

                 mediaRecorder.start();
                 isRecording = true;
                 voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
                 voiceButton.classList.add('recording');
             } catch (err) {
                 console.error('Error accessing microphone:', err);
                 alert('Could not access microphone. Please check permissions.');
             }
         }

         function stopVoiceRecording() {
             if (mediaRecorder && isRecording) {
                 mediaRecorder.stop();
                 isRecording = false;
                 voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                 voiceButton.classList.remove('recording');
             }
         }

         // Voice button click handler
         voiceButton.addEventListener('click', function() {
             if (isRecording) {
                 stopVoiceRecording();
             } else {
                 startVoiceRecording();
             }
         });

         // Handle file input change
         fileInput.addEventListener('change', function(e) {
             const file = e.target.files[0];
             if (file) {
                 // Check file size (limit to 15MB)
                 if (file.size > 15 * 1024 * 1024) {
                     alert('File size too large. Maximum 10MB allowed.');
                     return;
                 }

                 const reader = new FileReader();
                 reader.onload = function(e) {
                     const base64Data = e.target.result.split(',')[1]; // Remove data:mime;base64, prefix
                     
                     // Add file message to UI immediately
                     const messageEl = createFileMessage(currentUser, file.name, file.type, base64Data);
                     chatMessages.appendChild(messageEl);
                     scrollToBottom();

                     // Send file to WebSocket
                     chatSocket.send(JSON.stringify({
                         'type': 'file',
                         'filename': file.name,
                         'mimetype': file.type,
                         'data': base64Data
                     }));
                 };
                 reader.readAsDataURL(file);
             }
             // Clear the file input
             fileInput.value = '';
         });

         // File button click handler
         fileButton.addEventListener('click', function() {
             fileInput.click();
         });


         // On receiving message
         chatSocket.onmessage = function(e) {
             const data = JSON.parse(e.data);

             if (data.type === 'file') {
                // Handle file message
                const sender = data.sender;
                const isOwnMessage = sender === currentUser;
                
                // Skip if this is our own file (already displayed)
                if (isOwnMessage) {
                    return;
                }
                
                const messageEl = createFileMessage(sender, data.filename, data.mimetype, data.data);
                chatMessages.appendChild(messageEl);
                scrollToBottom();
             } else if (data.type === 'voice') {
                // Handle voice message
                const sender = data.sender;
                const isOwnMessage = sender === currentUser;
                
                // Skip if this is our own voice message (already displayed)
                if (isOwnMessage) {
                    return;
                }
                
                const messageEl = createVoiceMessage(sender, data.filename, data.mimetype, data.data);
                chatMessages.appendChild(messageEl);
                scrollToBottom();
              } else {
                const message = data.message;
                const sender = data.sender;

                // Check if this is our own message coming back from server
                const isOwnMessage = sender === currentUser;

                // Skip if this is a duplicate of the last message we sent
                if (isOwnMessage && lastSentMessage &&
                    lastSentMessage.message === message &&
                    Date.now() - lastSentMessage.timestamp < 2000) {
                    return; // Don't display duplicate
                }

                const messageEl = createMessage(sender, message);
                chatMessages.appendChild(messageEl);
                scrollToBottom();
             }
             
         };

         // On sending message
         function sendMessage() {
             const message = messageInput.value.trim();
             if (message) {
                 sendButton.disabled = true;

                 // Store the message we're sending to prevent duplicates
                 lastSentMessage = {
                     message: message,
                     timestamp: Date.now()
                 };

                 // Add own message to UI immediately
                 const messageEl = createMessage(currentUser, message);
                 chatMessages.appendChild(messageEl);
                 scrollToBottom();

                 // Send to WebSocket
                 chatSocket.send(JSON.stringify({
                    'type': 'text',
                    'message': message
                 }));

                 messageInput.value = '';
                 setTimeout(() => {
                     sendButton.disabled = false;
                     messageInput.focus();
                 }, 500);
             }
         }

         sendButton.onclick = sendMessage;

         messageInput.addEventListener("keypress", function(e) {
             if (e.key === "Enter" && !sendButton.disabled) {
                 sendMessage();
             }
         });

         // Auto-resize input
         messageInput.addEventListener('input', function() {
             this.style.height = 'auto';
             this.style.height = Math.min(this.scrollHeight, 120) + 'px';
         });

         // Focus input on page load and load chat history
         window.addEventListener('load', () => {
             loadChatHistory();
             messageInput.focus();
         });

         // Connection status handling
         chatSocket.onopen = function(e) {
             console.log('Connected to chat');
         };

         chatSocket.onclose = function(e) {
             console.log('Disconnected from chat');
         };

         chatSocket.onerror = function(e) {
             console.error('WebSocket error:', e);
         };

        document.addEventListener('DOMContentLoaded', function() {
          const membersToggle = document.getElementById('membersToggle');
          const membersList = document.getElementById('membersList');
          const closeMembersBtn = document.getElementById('closeMembersBtn');
          const leaveGroupBtn = document.getElementById('leaveGroupBtn');

          // Toggle members list
          if (membersToggle && membersList) {
            membersToggle.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();

              const isVisible = membersList.classList.contains('show');

              if (isVisible) {
                membersList.classList.remove('show');
                membersToggle.classList.remove('active');
              } else {
                membersList.classList.add('show');
                membersToggle.classList.add('active');
              }

              console.log('Toggle clicked, list visible:', !isVisible);
            });
          }

          // Close members list
          if (closeMembersBtn && membersList && membersToggle) {
            closeMembersBtn.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();

              membersList.classList.remove('show');
              membersToggle.classList.remove('active');
            });
          }

          // Leave group functionality
          if (leaveGroupBtn) {
            leaveGroupBtn.addEventListener('click', function(e) {
              e.preventDefault();

              if (confirm('Are you sure you want to leave this group?')) {
                console.log('User wants to leave group');
                // Add your leave group logic here
              }
            });
          }

          // Close members list when clicking outside
          document.addEventListener('click', function(event) {
            if (membersList && membersToggle) {
              if (!membersToggle.contains(event.target) && !membersList.contains(event.target)) {
                membersList.classList.remove('show');
                if (membersToggle.classList.contains('active')) {
                  membersToggle.classList.remove('active');
                }
              }
            }
          });
        });
    </script>
  </body>
</html>