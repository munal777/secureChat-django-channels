<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatApp - Private Room</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 50%,
          #2ecc71 100%
        );
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        position: relative;
        overflow: hidden;
      }

      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.05"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.05"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.03"/><circle cx="10" cy="50" r="0.5" fill="white" opacity="0.03"/><circle cx="90" cy="30" r="0.5" fill="white" opacity="0.03"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        pointer-events: none;
      }

      .chat-container {
        width: 100%;
        max-width: 850px;
        height: 88vh;
        max-height: 700px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        box-shadow: 0 32px 64px rgba(0, 0, 0, 0.12),
          0 0 0 1px rgba(255, 255, 255, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
      }

      .chat-header {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
        padding: 24px 28px;
        display: flex;
        align-items: center;
        gap: 16px;
        position: relative;
        overflow: hidden;
      }

      .chat-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          transparent 30%,
          rgba(255, 255, 255, 0.1) 50%,
          transparent 70%
        );
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .avatar {
        width: 52px;
        height: 52px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        border: 2px solid rgba(255, 255, 255, 0.3);
        position: relative;
        z-index: 1;
      }

      .header-info {
        flex: 1;
        position: relative;
        z-index: 1;
      }

      .header-info h2 {
        font-weight: 700;
        font-size: 22px;
        margin-bottom: 4px;
        letter-spacing: -0.02em;
      }

      .header-info .status {
        font-size: 13px;
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
      }

      .online-dot {
        width: 10px;
        height: 10px;
        background: #fff;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.1);
        }
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 32px 28px;
        background: linear-gradient(180deg, #fafbfc 0%, #f8fffe 100%);
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: relative;
      }

      .chat-messages::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: linear-gradient(
          180deg,
          rgba(250, 251, 252, 1) 0%,
          rgba(250, 251, 252, 0) 100%
        );
        pointer-events: none;
        z-index: 1;
      }

      .chat-messages::-webkit-scrollbar {
        width: 4px;
      }

      .chat-messages::-webkit-scrollbar-track {
        background: transparent;
      }

      .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(46, 204, 113, 0.3);
        border-radius: 2px;
      }

      .chat-messages::-webkit-scrollbar-thumb:hover {
        background: rgba(46, 204, 113, 0.5);
      }

      .message {
        display: flex;
        align-items: flex-end;
        gap: 12px;
        animation: messageSlide 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        max-width: 85%;
      }

      .message.own {
        flex-direction: row-reverse;
        margin-left: auto;
      }

      @keyframes messageSlide {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .date-separator {
        display: flex;
        align-items: center;
        margin: 32px 0 24px 0;
        opacity: 0.6;
      }

      .date-separator-line {
        flex: 1;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(46, 204, 113, 0.3),
          transparent
        );
      }

      .date-separator-text {
        padding: 0 16px;
        font-size: 12px;
        font-weight: 600;
        color: #7f8c8d;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        padding: 4px 12px;
        border: 1px solid rgba(46, 204, 113, 0.2);
      }

      .history-message {
        opacity: 0;
        animation: historyFadeIn 0.3s ease-out forwards;
      }

      .history-message:nth-child(n) {
        animation-delay: calc(var(--index, 0) * 0.05s);
      }

      @keyframes historyFadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 700;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.9);
      }

      .message.own .message-avatar {
        background: linear-gradient(135deg, #3498db, #2980b9);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
      }

      .message-content {
        background: white;
        padding: 16px 20px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08),
          0 1px 2px rgba(0, 0, 0, 0.05);
        position: relative;
        border: 1px solid rgba(46, 204, 113, 0.1);
        transition: all 0.2s ease;
      }

      .message-content:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12),
          0 2px 4px rgba(0, 0, 0, 0.08);
      }

      .message.own .message-content {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .message-content::before {
        content: "";
        position: absolute;
        width: 12px;
        height: 12px;
        background: white;
        transform: rotate(45deg);
        bottom: 6px;
      }

      .message:not(.own) .message-content::before {
        left: -5px;
        border-left: 1px solid rgba(46, 204, 113, 0.1);
        border-bottom: 1px solid rgba(46, 204, 113, 0.1);
      }

      .message.own .message-content::before {
        right: -5px;
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        border-right: 1px solid rgba(255, 255, 255, 0.2);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .message-sender {
        font-size: 12px;
        font-weight: 700;
        color: #2ecc71;
        margin-bottom: 6px;
        letter-spacing: 0.02em;
      }

      .message.own .message-sender {
        color: rgba(255, 255, 255, 0.9);
      }

      .message-text {
        font-size: 15px;
        line-height: 1.5;
        word-wrap: break-word;
        color: #2c3e50;
      }

      .message.own .message-text {
        color: white;
      }

      .message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 6px;
        font-weight: 500;
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        padding: 40px;
      }

      .empty-state-icon {
        font-size: 64px;
        margin-bottom: 24px;
        opacity: 0.4;
        animation: float 3s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .empty-state-text {
        font-size: 18px;
        color: #7f8c8d;
        font-weight: 500;
        margin-bottom: 8px;
      }

      .empty-state-subtext {
        font-size: 14px;
        color: #bdc3c7;
      }

      .chat-input-container {
        padding: 28px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(46, 204, 113, 0.1);
      }

      .chat-input {
        display: flex;
        align-items: center;
        gap: 16px;
        background: white;
        border: 2px solid rgba(46, 204, 113, 0.2);
        border-radius: 28px;
        padding: 6px 8px 6px 24px;
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        box-shadow: 0 8px 32px rgba(46, 204, 113, 0.08),
          0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .chat-input:focus-within {
        border-color: #2ecc71;
        box-shadow: 0 12px 40px rgba(46, 204, 113, 0.15),
          0 0 0 4px rgba(46, 204, 113, 0.08);
        transform: translateY(-2px);
      }

      .message-input {
        flex: 1;
        border: none;
        outline: none;
        background: transparent;
        font-size: 16px;
        padding: 16px 0;
        color: #2c3e50;
        font-weight: 500;
      }

      .message-input::placeholder {
        color: #bdc3c7;
        font-weight: 400;
      }

      .send-button {
        width: 48px;
        height: 48px;
        border: none;
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        font-size: 18px;
        font-weight: bold;
        box-shadow: 0 4px 16px rgba(46, 204, 113, 0.3);
        position: relative;
        overflow: hidden;
      }

      .send-button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.5s;
      }

      .send-button:hover {
        transform: scale(1.05) rotate(5deg);
        box-shadow: 0 8px 24px rgba(46, 204, 113, 0.4);
      }

      .send-button:hover::before {
        left: 100%;
      }

      .send-button:active {
        transform: scale(0.95);
      }

      .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      @media (max-width: 768px) {
        body {
          padding: 8px;
        }

        .chat-container {
          height: 92vh;
          border-radius: 20px;
          max-height: none;
        }

        .chat-header {
          padding: 20px 24px;
        }

        .chat-messages {
          padding: 24px 20px;
          gap: 16px;
        }

        .chat-input-container {
          padding: 20px;
        }

        .message {
          max-width: 90%;
        }

        .message-content {
          padding: 14px 18px;
        }
      }

      @media (max-width: 480px) {
        .chat-header {
          padding: 16px 20px;
        }

        .avatar {
          width: 44px;
          height: 44px;
          font-size: 18px;
        }

        .header-info h2 {
          font-size: 20px;
        }

        .chat-messages {
          padding: 20px 16px;
        }

        .chat-input-container {
          padding: 16px;
        }

        .message-content {
          padding: 12px 16px;
        }

        .message-text {
          font-size: 14px;
        }
      }

      /* File content styling - Add these styles to your existing CSS */

      /* File preview container */
      .file-preview {
        margin: 8px 0;
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.02);
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .message.own .file-preview {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      /* Image preview styling */
      .file-preview img {
        width: 100%;
        height: auto;
        max-width: 280px;
        max-height: 200px;
        object-fit: cover;
        display: block;
        border-radius: 12px;
        transition: transform 0.2s ease;
        cursor: pointer;
      }

      .file-preview img:hover {
        transform: scale(1.02);
      }

      /* Video preview styling */
      .file-preview video {
        width: 100%;
        height: auto;
        max-width: 280px;
        max-height: 200px;
        border-radius: 12px;
        background: #000;
      }

      /* File attachment styling */
      .file-attachment {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(248, 249, 250, 0.8);
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.06);
        margin: 8px 0;
        transition: all 0.2s ease;
        min-width: 200px;
        max-width: 300px;
      }

      .message.own .file-attachment {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .file-attachment:hover {
        background: rgba(248, 249, 250, 1);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .message.own .file-attachment:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* File icon styling */
      .file-icon {
        font-size: 24px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(46, 204, 113, 0.1);
        border-radius: 8px;
        flex-shrink: 0;
      }

      .message.own .file-icon {
        background: rgba(255, 255, 255, 0.2);
      }

      /* File info styling */
      .file-info {
        flex: 1;
        min-width: 0;
      }

      .file-name {
        font-size: 14px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .message.own .file-name {
        color: rgba(255, 255, 255, 0.95);
      }

      .file-size {
        font-size: 12px;
        color: #7f8c8d;
        font-weight: 500;
      }

      .message.own .file-size {
        color: rgba(255, 255, 255, 0.7);
      }

      /* File download button styling */
      .file-download {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(46, 204, 113, 0.1);
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.2s ease;
        flex-shrink: 0;
        color: #2ecc71;
      }

      .message.own .file-download {
        background: rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.9);
      }

      .file-download:hover {
        background: rgba(46, 204, 113, 0.2);
        transform: scale(1.1);
      }

      .message.own .file-download:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* File button styling (attach button) */
      .file-button {
        width: 40px;
        height: 40px;
        border: none;
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 16px;
        flex-shrink: 0;
      }

      .file-button:hover {
        background: rgba(46, 204, 113, 0.2);
        transform: scale(1.05);
      }

      .file-button:active {
        transform: scale(0.95);
      }

      /* Image modal for full-size viewing */
      .image-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
      }

      .image-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .image-modal img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }

      .image-modal-close {
        position: absolute;
        top: 20px;
        right: 30px;
        font-size: 30px;
        color: white;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.5);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .image-modal-close:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: scale(1.1);
      }

      /* Mobile responsive adjustments */
      @media (max-width: 768px) {
        .file-preview img,
        .file-preview video {
          max-width: 220px;
          max-height: 160px;
        }
        
        .file-attachment {
          max-width: 250px;
          min-width: 180px;
        }
        
        .file-name {
          font-size: 13px;
        }
        
        .file-size {
          font-size: 11px;
        }
      }

      @media (max-width: 480px) {
        .file-preview img,
        .file-preview video {
          max-width: 200px;
          max-height: 140px;
        }
        
        .file-attachment {
          max-width: 220px;
          min-width: 160px;
          padding: 10px;
        }
        
        .file-icon {
          font-size: 20px;
          width: 36px;
          height: 36px;
        }
        
        .file-download {
          width: 28px;
          height: 28px;
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <div class="avatar">
          <span id="room-avatar">üí¨</span>
        </div>
        <div class="header-info">
          <h2 id="room-name">{{ room_member }}</h2>
          <div class="status">
            <div class="online-dot"></div>
            <span>Active now</span>
          </div>
        </div>
      </div>

      <div class="chat-messages" id="chat-messages">
        <div class="empty-state">
          <div class="empty-state-icon">üí¨</div>
          <div class="empty-state-text">Start your conversation</div>
          <div class="empty-state-subtext">
            Send a message to begin chatting
          </div>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="chat-input">
          <input
            type="text"
            id="message-input"
            class="message-input"
            placeholder="Type your message..."
            autocomplete="off"
          />
          <input
            type="file"
            id="file-input"
            accept="image/*,video/*,.pdf,.doc,.docx,.txt,.zip,.rar"
            style="display: none;"
          />
          <button id="file-button" class="file-button">üìé</button>
          <button id="send-button" class="send-button">‚û§</button>
        </div>
      </div>
    </div>

    <script>
         const roomName = "{{ room_name }}";
         const currentUser = "{{ request.user.username }}"; // Get current user from Django
         const chatSocket = new WebSocket(
             'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
         );

         const chatMessages = document.getElementById('chat-messages');
         const messageInput = document.getElementById('message-input');
         const sendButton = document.getElementById('send-button');
         const fileInput = document.getElementById('file-input');
         const fileButton = document.getElementById('file-button');

        // Chat history from Django context
        const chatHistory = [
        {% for message in messages %}
            {
                sender: "{{ message.sender.username|escapejs }}",
                message: "{{ message.content|escapejs }}",
                timestamp: "{{ message.timestamp|date:'c' }}"
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
        ];


         // Remove empty state when first message arrives
         function removeEmptyState() {
             const emptyState = chatMessages.querySelector('.empty-state');
             if (emptyState) {
                 emptyState.style.animation = 'messageSlide 0.3s reverse';
                 setTimeout(() => emptyState.remove(), 300);
             }
         }

         // Format time from timestamp
         function formatTime(timestamp = null) {
             const date = timestamp ? new Date(timestamp) : new Date();
             return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
         }

         // Format date for message grouping
         function formatDate(timestamp) {
             const date = new Date(timestamp);
             const today = new Date();
             const yesterday = new Date(today);
             yesterday.setDate(yesterday.getDate() - 1);

             if (date.toDateString() === today.toDateString()) {
                 return 'Today';
             } else if (date.toDateString() === yesterday.toDateString()) {
                 return 'Yesterday';
             } else {
                 return date.toLocaleDateString([], {
                     month: 'short',
                     day: 'numeric',
                     year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
                 });
             }
         }

         // Create date separator
         function createDateSeparator(dateStr) {
             const separator = document.createElement('div');
             separator.className = 'date-separator';
             separator.innerHTML = `
                 <div class="date-separator-line"></div>
                 <div class="date-separator-text">${dateStr}</div>
                 <div class="date-separator-line"></div>
             `;
             return separator;
         }

          // Format file size
         function formatFileSize(bytes) {
             if (bytes === 0) return '0 Bytes';
             const k = 1024;
             const sizes = ['Bytes', 'KB', 'MB', 'GB'];
             const i = Math.floor(Math.log(bytes) / Math.log(k));
             return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
         }

          
        // Enhanced file icon function with more file types
        function getFileIcon(mimetype) {
            if (mimetype.startsWith('image/')) return 'üñºÔ∏è';
            if (mimetype.startsWith('video/')) return 'üé•';
            if (mimetype.startsWith('audio/')) return 'üéµ';
            if (mimetype.includes('pdf')) return 'üìÑ';
            if (mimetype.includes('word') || mimetype.includes('document')) return 'üìù';
            if (mimetype.includes('excel') || mimetype.includes('spreadsheet')) return 'üìä';
            if (mimetype.includes('powerpoint') || mimetype.includes('presentation')) return 'üìä';
            if (mimetype.includes('zip') || mimetype.includes('rar') || mimetype.includes('7z')) return 'üì¶';
            if (mimetype.includes('text/')) return 'üìÉ';
            if (mimetype.includes('json') || mimetype.includes('xml')) return '‚öôÔ∏è';
            return 'üìÅ';
        }

         // Function to open image in modal
        function openImageModal(imageSrc, filename) {
            let modal = document.getElementById('imageModal');
            if (!modal) {
                // Create modal if it doesn't exist
                modal = document.createElement('div');
                modal.id = 'imageModal';
                modal.className = 'image-modal';
                modal.innerHTML = `
                    <span class="image-modal-close" onclick="closeImageModal()">√ó</span>
                    <img id="modalImage" src="" alt="">
                `;
                document.body.appendChild(modal);
                
                // Close modal when clicking outside the image
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeImageModal();
                    }
                });
            }
            
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modalImage.alt = filename;
            modal.classList.add('active');
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        // Function to close image modal
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }

        // Add keyboard support for closing modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });

         // Create file message element
         function createFileMessage(sender, filename, mimetype, data, timestamp = null, isOwnMessage = null) {
             removeEmptyState();

             // Auto-detect if it's own message if not specified
             if (isOwnMessage === null) {
                 isOwnMessage = sender === currentUser;
             }

             const messageEl = document.createElement('div');
             messageEl.className = `message ${isOwnMessage ? 'own' : ''}`;

             const avatarLetter = sender.charAt(0).toUpperCase();
             const time = formatTime(timestamp);
             const displaySender = isOwnMessage ? 'You' : sender;
             const fileIcon = getFileIcon(mimetype);
             const fileSize = formatFileSize(atob(data).length);

             let fileContent = '';
             
             if (mimetype.startsWith('image/')) {
                 fileContent = `
                      <div class="file-preview">
                         <img src="data:${mimetype};base64,${data}"
                              alt="${filename}"
                              onclick="openImageModal(this.src, '${filename}')"
                              title="Click to view full size">
                      </div>
                      <div class="file-info" style="padding: 4px 0;">
                        <div class="file-name">${filename}</div>
                        <div class="file-size">${fileSize}</div>
                      </div>
                 `;
             } else if (mimetype.startsWith('video/')) {
                 fileContent = `
                      <div class="file-preview">
                         <video controls preload="metadata">
                             <source src="data:${mimetype};base64,${data}" type="${mimetype}">
                             Your browser does not support the video tag.
                         </video>
                      </div>
                      <div class="file-info" style="padding: 4px 0;">
                          <div class="file-name">${filename}</div>
                          <div class="file-size">${fileSize}</div>
                      </div>
                 `;
             } else {
                 fileContent = `
                     <div class="file-attachment">
                         <div class="file-icon">${fileIcon}</div>
                         <div class="file-info">
                             <div class="file-name" title="${filename}">${filename}</div>
                             <div class="file-size">${fileSize}</div>
                         </div>
                         <a href="data:${mimetype};base64,${data}" 
                            download="${filename}" 
                            class="file-download"
                            title="Download file">‚¨áÔ∏è</a>
                     </div>
                 `;
             }

             messageEl.innerHTML = `
                 <div class="message-avatar">${avatarLetter}</div>
                 <div class="message-content">
                     <div class="message-sender">${displaySender}</div>
                     ${fileContent}
                     <div class="message-time">${time}</div>
                 </div>
             `;

             return messageEl;
         }

         // Create text message element
         function createMessage(sender, message, timestamp = null, isOwnMessage = null) {
             removeEmptyState();

             // Auto-detect if it's own message if not specified
             if (isOwnMessage === null) {
                 isOwnMessage = sender === currentUser;
             }

             const messageEl = document.createElement('div');
             messageEl.className = `message ${isOwnMessage ? 'own' : ''}`;

             const avatarLetter = sender.charAt(0).toUpperCase();
             const time = formatTime(timestamp);
             const displaySender = isOwnMessage ? 'You' : sender;

             messageEl.innerHTML = `
                 <div class="message-avatar">${avatarLetter}</div>
                 <div class="message-content">
                     <div class="message-sender">${displaySender}</div>
                     <div class="message-text">${message}</div>
                     <div class="message-time">${time}</div>
                 </div>
             `;

             return messageEl;
         }

         // Load chat history
         function loadChatHistory() {
             if (chatHistory.length === 0) return;

             removeEmptyState();

             let lastDate = null;

             chatHistory.forEach(historyMessage => {
                 const messageDate = formatDate(historyMessage.timestamp);

                 // Add date separator if date changed
                 if (messageDate !== lastDate) {
                     const dateSeparator = createDateSeparator(messageDate);
                     chatMessages.appendChild(dateSeparator);
                     lastDate = messageDate;
                 }

                 const messageEl = createMessage(
                     historyMessage.sender,
                     historyMessage.message,
                     historyMessage.timestamp
                 );

                 // Add history class for styling with staggered animation
                 messageEl.classList.add('history-message');
                 messageEl.style.setProperty('--index', chatHistory.indexOf(historyMessage));
                 chatMessages.appendChild(messageEl);
             });

             // Scroll to bottom after loading history
             setTimeout(() => {
                 chatMessages.scrollTop = chatMessages.scrollHeight;
             }, 100);
         }

         // Smooth scroll to bottom
         function scrollToBottom() {
             chatMessages.scrollTo({
                 top: chatMessages.scrollHeight,
                 behavior: 'smooth'
             });
         }

         let lastSentMessage = null; // Track last sent message to prevent duplicates

         // Handle file input change
         fileInput.addEventListener('change', function(e) {
             const file = e.target.files[0];
             if (file) {
                 // Check file size (limit to 10MB)
                 if (file.size > 10 * 1024 * 1024) {
                     alert('File size too large. Maximum 10MB allowed.');
                     return;
                 }

                 const reader = new FileReader();
                 reader.onload = function(e) {
                     const base64Data = e.target.result.split(',')[1]; // Remove data:mime;base64, prefix
                     
                     // Add file message to UI immediately
                     const messageEl = createFileMessage(currentUser, file.name, file.type, base64Data);
                     chatMessages.appendChild(messageEl);
                     scrollToBottom();

                     // Send file to WebSocket
                     chatSocket.send(JSON.stringify({
                         'type': 'file',
                         'filename': file.name,
                         'mimetype': file.type,
                         'data': base64Data
                     }));
                 };
                 reader.readAsDataURL(file);
             }
             // Clear the file input
             fileInput.value = '';
         });

         // File button click handler
         fileButton.addEventListener('click', function() {
             fileInput.click();
         });


         // On receiving message
         chatSocket.onmessage = function(e) {
             const data = JSON.parse(e.data);

             if (data.type === 'file') {
                // Handle file message
                const sender = data.sender;
                const isOwnMessage = sender === currentUser;
                
                // Skip if this is our own file (already displayed)
                if (isOwnMessage) {
                    return;
                }
                
                const messageEl = createFileMessage(sender, data.filename, data.mimetype, data.data);
                chatMessages.appendChild(messageEl);
                scrollToBottom();
             } else {
                const message = data.message;
                const sender = data.sender;

                // Check if this is our own message coming back from server
                const isOwnMessage = sender === currentUser;

                // Skip if this is a duplicate of the last message we sent
                if (isOwnMessage && lastSentMessage &&
                    lastSentMessage.message === message &&
                    Date.now() - lastSentMessage.timestamp < 2000) {
                    return; // Don't display duplicate
                }

                const messageEl = createMessage(sender, message);
                chatMessages.appendChild(messageEl);
                scrollToBottom();
             }
             
         };

         // On sending message
         function sendMessage() {
             const message = messageInput.value.trim();
             if (message) {
                 sendButton.disabled = true;

                 // Store the message we're sending to prevent duplicates
                 lastSentMessage = {
                     message: message,
                     timestamp: Date.now()
                 };

                 // Add own message to UI immediately
                 const messageEl = createMessage(currentUser, message);
                 chatMessages.appendChild(messageEl);
                 scrollToBottom();

                 // Send to WebSocket
                 chatSocket.send(JSON.stringify({
                    'type': 'text',
                    'message': message
                 }));

                 messageInput.value = '';
                 setTimeout(() => {
                     sendButton.disabled = false;
                     messageInput.focus();
                 }, 500);
             }
         }

         sendButton.onclick = sendMessage;

         messageInput.addEventListener("keypress", function(e) {
             if (e.key === "Enter" && !sendButton.disabled) {
                 sendMessage();
             }
         });

         // Auto-resize input
         messageInput.addEventListener('input', function() {
             this.style.height = 'auto';
             this.style.height = Math.min(this.scrollHeight, 120) + 'px';
         });

         // Focus input on page load and load chat history
         window.addEventListener('load', () => {
             loadChatHistory();
             messageInput.focus();
         });

         // Connection status handling
         chatSocket.onopen = function(e) {
             console.log('Connected to chat');
         };

         chatSocket.onclose = function(e) {
             console.log('Disconnected from chat');
         };

         chatSocket.onerror = function(e) {
             console.error('WebSocket error:', e);
         };
    </script>
  </body>
</html>